# Overcoming NSP Noise
A project aimed to overcome thermal noise generated by the heat of near sensor processing using a neural network trained on images with high amounts of thermal noise.
This project is being carried out as an independent study which has started in the spring of 2022. 

#### Collaborators
Christopher Bruinsma and Yuhao Zhu at Horizon Research, *Univerisity of Rochester*

## Capture
Images will be captured using a FLIR BlackFly 3 camera which has thermal-noise induced using a heat-gun. 
The safety of heating the camera will be safely heated using Python code which relies on the Spinnaker SDK from FLIR. I read somewhere that it can be heated to
```100Â°C```
, I found out today *February 22, 2022*, that is indeed correct. 

This script is called ```HeatTrigger.py```, it is essentially a camera trigger that triggers based on heat. 

#### Depends on

```python
import PySpin
import sys
import time
```

#### Runs as 
```$ Python3 HeatTrigger.py```

Main additions to FLIR SDK example ```Trigger.py``` are :

For the device temperature: ```GetCameraTemperature(cam)``` :

```python
def GetCameraTemperature(cam):
    x = 0
    if cam.DeviceTemperature.GetAccessMode() == PySpin.RO:
        x = cam.DeviceTemperature.ToString()
    x = float(x)
    return x
```
as well as:  ```Go(cam,GoalTemperature)```

```python
def Go(cam, GoalTemperature):
    # Get Temperature of Camera

    Temp = GetCameraTemperature(cam)
    print(GoalTemperature)

    # Heating
    while Temp < GoalTemperature:
        cam.Init()
        Temp = GetCameraTemperature(cam)
        print(Temp)
        time.sleep(3)  # Protects the camera.

    # Capture 2 images
    if Temp > GoalTemperature:
        # cam.DeInit() This makes the who thing crash much more quickly
        print("Capturing, please continue heating")
        Capture(cam)  # Cites : FLIR TELEDYNE
```

The heat testing is done using a loop in the ``` main()``` method. 

```python
def main():
    ...
    # List of Cameras
    for i, cam in enumerate(cam_list):
        # List of Temperatures
        for t in range(50, 80, 5):
            # Initiates Capture
            Go(cam, t)
            time.sleep(2)
    
    print("Capture Complete, please cool the camera.")
    ... 
```
Images are saved as  ```sample-serialNumber-capNum-temp.png```

The numbering relies on the ```CamConfig.json``` which stores the number of captures after each capture. 
In the terminal it looks like the following 
```
...
$ Acquiring images...
$ Image saved at sample-18255214-12-39.png

$ Image saved at sample-18255214-13-39.png

$ Trigger mode disabled...
...
```



## Neural Network
Due to the nature of image processing of noisy images, max-pooling will likely be used alongside some kind of edge dectection algorthim. This aspect very much remains in the research stage, but as of right now the goal is to train a Convolution Neural Network to indentify cups of coffee that have my name on them. 

#### Runs as
```$ IgnoresThermal.py``` 

#### Intent 
Indentify cups of coffee that have my name on them. This will be done using a variety of coffee cups the on-campus Starbucks here at the Univeristy. 
These are contained withing the ```Training_Data``` folder

#### Depends on

```python
import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
```
As well as ```pydot``` and ```graphviz```

#### When Running 

Here is the test image, it is 100% my coffee 
![Model](TEST2.png)

```
...
Epoch 47/50
2/2 [==============================] - 5s 2s/step - loss: 0.0859 - accuracy: 0.9649 - val_loss: 0.9109 - val_accuracy: 0.5714
Epoch 48/50
2/2 [==============================] - 5s 2s/step - loss: 0.0834 - accuracy: 0.9474 - val_loss: 0.9245 - val_accuracy: 0.5714
Epoch 49/50
2/2 [==============================] - 5s 2s/step - loss: 0.0816 - accuracy: 0.9649 - val_loss: 0.9345 - val_accuracy: 0.5714
Epoch 50/50
2/2 [==============================] - 5s 2s/step - loss: 0.0305 - accuracy: 1.0000 - val_loss: 0.9464 - val_accuracy: 0.5714
This image is 13.87 percent your coffee.
...
```
*To be fair* this has only been run 50 times. *Perhaps* more epochs are needed or simply a bigger sample space. 

A more research-based answer would be that this is a classic case of overfitting, when performing 200 epochs the percentage is even lower than this for the same image at ```0.00%```


```
...
Epoch 47/50
2/2 [==============================] - 29s 14s/step - loss: 0.2010 - accuracy: 0.9483 - val_loss: 0.7452 - val_accuracy: 0.4286
Epoch 48/50
2/2 [==============================] - 28s 14s/step - loss: 0.1468 - accuracy: 0.9483 - val_loss: 0.7051 - val_accuracy: 0.3571
Epoch 49/50
2/2 [==============================] - 28s 14s/step - loss: 0.1958 - accuracy: 0.9655 - val_loss: 0.6946 - val_accuracy: 0.5714
Epoch 50/50
2/2 [==============================] - 30s 15s/step - loss: 0.2842 - accuracy: 0.8448 - val_loss: 0.6976 - val_accuracy: 0.5714
This image is 45.06 percent your coffee.
...
```

After some tweaking to the ```def NModel(input_shape,num_classes)```, and use of the same image, and 50 epochs a your-coffee percentage was achieved at *45.06*%
The improvement is likely due to changing the activation from ```relu``` to ```softplus``` and giving the Neural Net larger fields to convolve over. 


### Works Cited :
> Dynamic Temperature Management of Near-Sensor Processing for Energy-Efficient High-Fidelity 
    Imaging. Kodukula Et Al.

> Dirty Pixels: Towards End-to-End Image Processing and Perception Diamond Et. Al.

> FLIR. (n.d.). Spinnaker-SDKVersion (Trigger.py). Spinnaker SDK. Retrieved from https://www.flir.com/products/spinnaker-sdk/. 

> FLIR Integrated Imaging Solutions, Inc. (n.d.). PySpinDoc. 

> Team, K. (n.d.). Keras documentation: Image Classification From Scratch. Keras. Retrieved February 22, 2022, from 
   https://keras.io/examples/vision/image_classification_from_scratch/ 
